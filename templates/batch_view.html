{% extends "base.html" %}
{% block content %}

<div class="card">
  <h2>{{ batch["name"] }}</h2>

  <div class="top-tools">
    <button class="tool-btn" type="button" onclick="toggleHighlight()">Highlight</button>

    <div class="last-fed">
      <div class="last-fed-label">Last fed section:</div>

      <div class="last-fed-preview" id="lastFedPreview"
           {% if last_fed_color %} style="background: {{ last_fed_color }};" {% endif %}></div>

      <button class="tool-btn" type="button" onclick="toggleLastFed()">Pick</button>

      <div id="lastFedPalette" class="palette hidden" style="margin-top:10px;">
        {% for c in color_options %}
          <button class="swatch" type="button" style="background: {{ c }};"
                  onclick="setLastFedColor('{{ c }}', {{ batch['id'] }})"></button>
        {% endfor %}
        <button class="swatch clear" type="button" onclick="setLastFedColor('', {{ batch['id'] }})">✕</button>
      </div>
    </div>
  </div>

  <div id="palette" class="palette hidden">
    {% for c in color_options %}
      <button class="swatch" type="button" style="background: {{ c }};" onclick="selectColor('{{ c }}')"></button>
    {% endfor %}
    <button class="swatch clear" type="button" onclick="selectColor('')">✕</button>
  </div>

  <div class="subtle" id="highlightStatus">Highlight mode: Off</div>
  <div class="subtle">Tap a spider to edit ({{ day }})</div>
</div>

<div class="card pad-bottom-safe">
  <div class="spider-grid">
    {% for spider in spiders %}
      {% set hc = highlight_map.get(spider["id"], '') %}
      <button class="spider-chip"
              data-spider-id="{{ spider['id'] }}"
              onclick="chipClick(event, {{ spider['id'] }})"
              {% if hc %} style="background: {{ hc }}; border-color: {{ hc }}; color:#fff;" {% endif %}>
        #{{ spider["number"] }}
      </button>

      {% set log = log_map.get(spider["id"]) %}
      {% set booty = (log["booty"] if log else 3) %}

      <dialog class="day-dialog" id="dlg{{ spider['id'] }}">
        <div class="day-dialog-header">
          <div>
            <div class="day-dialog-date">Spider #{{ spider["number"] }}</div>
            <div class="day-dialog-status">Day: {{ day }}</div>
          </div>
          <button class="day-dialog-close" type="button"
                  onclick="document.getElementById('dlg{{ spider['id'] }}').close()">✕</button>
        </div>

        <form method="post" action="/spiderlog/{{ spider['id'] }}/{{ day }}" onsubmit="return confirmApplyAll(this)">
          <div class="day-dialog-body">
            <input type="hidden" name="apply_all" value="0">
            <input type="hidden" name="booty" value="{{ booty }}" class="booty-input">

            <div class="field">
              <div class="label">Fed</div>
              <div class="seg">
                <label class="seg-item"><input type="radio" name="fed" value="yes" {% if log and log["fed"]=="yes" %}checked{% endif %}><span>Yes</span></label>
                <label class="seg-item"><input type="radio" name="fed" value="no"  {% if not log or log["fed"]!="yes" %}checked{% endif %}><span>No</span></label>
              </div>
            </div>

            <div class="field">
              <div class="label">Ate</div>
              <div class="seg">
                <label class="seg-item"><input type="radio" name="ate" value="yes" {% if log and log["ate"]=="yes" %}checked{% endif %}><span>Yes</span></label>
                <label class="seg-item"><input type="radio" name="ate" value="no"  {% if not log or log["ate"]!="yes" %}checked{% endif %}><span>No</span></label>
              </div>
            </div>

            <div class="field">
              <div class="label">Watered</div>
              <div class="seg">
                <label class="seg-item"><input type="radio" name="watered" value="yes" {% if log and log["watered"]=="yes" %}checked{% endif %}><span>Yes</span></label>
                <label class="seg-item"><input type="radio" name="watered" value="no"  {% if not log or log["watered"]!="yes" %}checked{% endif %}><span>No</span></label>
              </div>
              <div class="hint">Defaults to No unless you set Yes for this day.</div>
            </div>

            <div class="field">
              <div class="label">Molting</div>
              <div class="seg">
                <label class="seg-item"><input type="radio" name="molting" value="yes" {% if log and log["molting"]=="yes" %}checked{% endif %}><span>Yes</span></label>
                <label class="seg-item"><input type="radio" name="molting" value="no"  {% if not log or log["molting"]!="yes" %}checked{% endif %}><span>No</span></label>
              </div>
            </div>

            <div class="field">
              <div class="label">Abdomen size</div>
              <div class="booty-row" data-selected="{{ booty }}">
                {% for n in [1,2,3,4,5] %}
                  <button type="button" class="booty-btn booty-{{n}} {% if booty==n %}selected{% endif %}"
                          onclick="selectBooty(this, {{n}})"></button>
                {% endfor %}
              </div>
              <div class="hint">1 = skinny, 5 = very full</div>
            </div>

            <div class="field">
              <div class="label">Number of molts</div>
              <input class="input" type="number" min="0" name="molts_count" value="{{ (log['molts_count'] if log else 0) }}">
            </div>

            <div class="field">
              <div class="label">Notes</div>
              <textarea class="notes" name="notes">{{ (log['notes'] if log else '') }}</textarea>
            </div>

          </div>

          <input type="hidden" name="back" value="batch">

          <div class="day-dialog-actions">
            <button class="btn-outline" type="button"
                    onclick="document.getElementById('dlg{{ spider['id'] }}').close()">Close</button>
            <button class="btn" type="submit">Save</button>
          </div>
        </form>
      </dialog>

    {% endfor %}
  </div>
</div>

<script>
  let highlightMode = false;
  let currentColor = "";

  function toggleHighlight(){
    highlightMode = !highlightMode;
    document.getElementById("palette").classList.toggle("hidden", !highlightMode);
    document.getElementById("highlightStatus").textContent =
      "Highlight mode: " + (highlightMode ? "On (pick a color, then tap spiders)" : "Off");
  }

  function selectColor(c){
    currentColor = c;
    if(!highlightMode){
      highlightMode = true;
      document.getElementById("palette").classList.remove("hidden");
    }
    document.getElementById("highlightStatus").textContent =
      "Highlight mode: On (selected: " + (c ? "color" : "clear") + ")";
  }

  async function chipClick(evt, spiderId){
    evt.preventDefault();

    if(highlightMode){
      const fd = new FormData();
      fd.append("spider_id", spiderId);
      fd.append("color", currentColor);

      const res = await fetch("/set_highlight", { method: "POST", body: fd });
      if(res.ok){
        const btn = document.querySelector(`[data-spider-id="${spiderId}"]`);
        if(currentColor){
          btn.style.background = currentColor;
          btn.style.borderColor = currentColor;
          btn.style.color = "#fff";
        }else{
          btn.style.background = "";
          btn.style.borderColor = "";
          btn.style.color = "";
        }
      }
      return;
    }

    document.getElementById("dlg" + spiderId).showModal();
  }

  function confirmApplyAll(formEl){
    const yes = confirm("Apply these answers to ALL spiders for this day?");
    formEl.querySelector('input[name="apply_all"]').value = yes ? "1" : "0";
    return true;
  }

  function toggleLastFed(){
    document.getElementById("lastFedPalette").classList.toggle("hidden");
  }

  async function setLastFedColor(color, batchId){
    const fd = new FormData();
    fd.append("batch_id", batchId);
    fd.append("last_fed_color", color);

    const res = await fetch("/set_last_fed", { method:"POST", body: fd });
    if(res.ok){
      const preview = document.getElementById("lastFedPreview");
      preview.style.background = color ? color : "transparent";
      document.getElementById("lastFedPalette").classList.add("hidden");
    }
  }

  function selectBooty(btn, val){
    const row = btn.closest(".day-dialog");
    const input = row.querySelector(".booty-input");
    input.value = String(val);

    const all = btn.parentElement.querySelectorAll(".booty-btn");
    all.forEach(x => x.classList.remove("selected"));
    btn.classList.add("selected");
  }
</script>

{% endblock %}